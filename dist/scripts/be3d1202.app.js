(function(){var a,b,c,d,e,f=[].slice;_.mixin({multiSort:function(){var a,b,c;return a=arguments[0],c=2<=arguments.length?f.call(arguments,1):[],b=a.slice(),b.sort(function(a,b){var d,e,f,g;for(f=0,g=c.length;g>f;f++)if(d=c[f],0!==(e=d(a,b)))return e;return e})},splitAt:function(a,b){return[_.take(a,b),_.drop(a,b)]},weave:function(){var a;return a=1<=arguments.length?f.call(arguments,0):[],_.any(a)?_.compact(_.flatten(_.zip.apply(_,a),!0)):[]},concat:function(){var a;return a=1<=arguments.length?f.call(arguments,0):[],_.reduce(_.compact(a),function(a,b){return a.concat(b)},[])},replace:function(){var a,b;return b=arguments[0],a=2<=arguments.length?f.call(arguments,1):[],b.replace.apply(b,a)},idify:function(a){return _.stripDiacritics(_.dasherize(a.toLowerCase().replace(/["|'|:|*]/g,"")))},filterObj:function(a,b){var c,d;return _.object(function(){var e;e=[];for(c in a)d=a[c],b(c,d)&&e.push([c,d]);return e}())},noop:function(){}}),_.mixin({sum:function(a){return _.reduce(a,function(a,b){return a+b},0)},average:function(a){return _.isEmpty(a)?null:_.sum(a)/a.length},median:function(a){var b;return _.isEmpty(a)?null:(b=a.slice().sort(function(a,b){return a-b}),0===b.length%2?(b[a.length/2-1]+b[a.length/2])/2:b[Math.floor(a.length/2)])}}),e=function(a){return function(b,c){return function(){var d,e;return d=1<=arguments.length?f.call(arguments,0):[],e=this,_[a](b,_.bind.apply(_,[c,e].concat(f.call(d))))}}},_.mixin({profile:function(a,b){var c;b?c=a:(b=a,c="");try{return console.profile(c),b()}finally{console.profileEnd(c)}},time:function(a,b){try{return"function"==typeof console.time&&console.time(a),b()}finally{"function"==typeof console.timeEnd&&console.timeEnd(a)}},logGroup:function(a,b){try{return"function"==typeof console.group&&console.group(a),b()}finally{"function"==typeof console.groupEnd&&console.groupEnd(a)}},profiled:e("profile"),timed:e("time"),logGrouped:e("logGroup")}),a="ąàáäâãåæăćęèéëêìíïîłńòóöôõōøśșțùúüûñçżź",d="aaaaaaaaaceeeeeiiiilnooooooosstuuuunczz",c=RegExp("["+a+"]","g"),b=_.object(_.zip(_.str.chars(a),_.str.chars(d))),_.mixin({stripDiacritics:function(a){return a=String(a).toLowerCase().replace(c,function(a){return b[a]})}})}).call(this),function(){var a,b=[].slice;_.mixin(_.str.exports()),angular.module("onoSendai",["ui.bootstrap.buttons","pasvaz.bindonce"]).config(["$locationProvider",function(b){return a(),b.html5Mode(!0),FastClick.attach(document.body)}]),a=function(){var a,c,d,e,f,g,h,i;return i=["#000"],c=["#2D053D","#440C59","#60157C","#79209D","#9927BF"],g=_(c).chain().clone().reverse().concat(i,c).map(function(a){return"font-size: 10px; background: "+a+"; color: white; padding: 3px 1px;"}).value(),d=_.repeat("%c ",c.length),e=16,f=_.repeat(" ",e),h=_.center("ONO-SENDAI",e),a=_.center("by scott hyndman",e),_.each([f,h,a,f],function(a){return console.log.apply(console,[""+d+"%c "+a+" "+d].concat(b.call(g)))}),console.log("")}}.call(this),angular.module("onoSendai").run(["$templateCache",function(a){a.put("/views/cards.html",'<div class="cards">\n  <card-view ng-show="cardsUI.layoutMode == \'detail\'"></card-view>\n\n  <matrix\n      ng-show="cardsUI.layoutMode == \'grid\'"\n      query-result="queryResult"\n      selection="selectedCard"\n      zoom="cardsUI.zoom">\n\n    <!-- HEADERS -->\n    <h2 ng-repeat="(id, group) in queryResult.groups track by id"\n        grid-id="{{ group.id }}"\n        class="{{ group.id }} grid-header invisible"\n        title="{{ group.id }}">\n      <small class="card-count"><ng-pluralize\n          count="group.cards.length"\n          when="{\n            \'1\': \'1 card\',\n            \'other\': \'{} cards\'\n          }"></ng-pluralize>\n      </small>\n      {{ group.title|primaryGroupTitle:filter.groupings }}\n      <small class="secondary-group">{{ group.title|secondaryGroupTitle:filter.groupings }}</small>\n    </h2>\n\n    <!--\n      CARDS\n\n      Note:\n      For performance reasons, this template is bound once, with all the cards, then never touched\n      again. All sorting and show/hide logic for cards exists in the ui-matrix directive.\n    -->\n    <div ng-repeat="card in cards track by card.id"\n         bindonce\n         class="grid-item hidden"\n         ng-click="selectCard(card)"\n         bo-title="card.title"\n         bo-attr-grid-id="card.id"\n         bo-attr>\n      <img bo-src="card | cardUrl:\'image\'" width="300" height="418">\n    </div>\n\n    <!-- No results -->\n    <div ng-show="queryResult.length == 0"\n         class="no-results">\n      <h2>\n        <small class="card-count">0 cards</small>\n        No Results Found\n      </h2>\n    </div>\n  </matrix>\n</div>\n'),a.put("/views/directives/nr-card-view.html",'<div class="wing">\n  <div class="wing-click-region" ng-click="selectPreviousCard()"></div>\n  <div ng-repeat="card in cardsBefore track by card.id"\n       class="card-image in-wing prev prev-{{ cardsBefore.length - $index - 1 }}">\n    <img ng-src="{{ card.imagesrc }}" width="300" height="418">\n    <div class="background"></div>\n  </div>\n</div>\n<div class="selected-card" ng-if="card != null">\n  <!-- Fancy header -->\n  <h2 class="card-name {{ card.faction.toLowerCase() }}">\n    {{ card.title }}\n    <small class="favourite"\n           ng-click="toggleFavourite(card)"\n           ng-class="{ \'on\': isFavourite(card) }"\n           ng-switch="isFavourite(card)">\n      <span ng-switch-when="false">☆</span>\n      <span ng-switch-when="true">★</span>\n    </small>\n\n    <span class="close" ng-click="deselectCard()">&times;</span>\n\n    <ul class="nav nav-tabs">\n      <li ng-class="{ active: cardUI.page == \'info\' }">\n        <a ng-model="cardUI.page" btn-radio="\'info\'">\n          <i class="icon-info"></i>\n        </a>\n      </li>\n      <li ng-class="{\n            active: cardUI.page == \'cost-to-break\',\n            disabled: !isCostToBreakEnabled(card)\n          }">\n        <a ng-model="cardUI.page" btn-radio="\'cost-to-break\'">\n          <i class="icon-calculator"></i>\n        </a>\n      </li>\n    </ul>\n  </h2>\n\n  <div class="card-content">\n    <div ng-repeat="cardImage in cardAndNeighbours track by cardImage.card.id"\n         class="card-image {{ cardImage.class }}">\n      <img ng-src="{{ cardImage.card.imagesrc }}" width="300" height="418">\n    </div>\n\n    <div class="info">\n      <div ng-switch="cardUI.page">\n        <div ng-switch-when="cost-to-break">\n          <cost-to-break-calculator card="card"></cost-to-break-calculator>\n        </div>\n        <div class="general"\n             ng-switch-when="info">\n          <div class="info-row">\n            <span class="info-label">Type:</span>\n            <div class="info-value">\n              <a ng-href="{{ card | cardUrl:\'type\' }}">\n                {{ card.type }}\n              </a>\n            </div>\n          </div>\n          <div ng-if="card.subtypes.length > 0" class="info-row">\n            <span class="info-label">Subtypes:</span>\n            <div class="info-value">\n              <span ng-repeat="subtype in card.subtypes">\n                <a ng-href="{{ card | cardUrl:\'subtype\':subtype }}">{{ subtype }}</a><span ng-if="!$last"> - </span>\n              </span>\n            </div>\n          </div>\n          <div class="info-row">\n            <span class="info-label">From:</span>\n            <div class="info-value">\n              <a ng-href="{{ card | cardUrl:\'set\' }}">{{ card.setname }}</a>\n            </div>\n          </div>\n          <div ng-if="isShortCard(card)" class="info-row">\n            <span class="info-label">Quantity:</span>\n            <div class="info-value">\n              <span class=\'short-cards\'>{{ card.quantity }} in set</span>\n            </div>\n          </div>\n\n          <ul class="links">\n            <!-- Reddit cards of the day -->\n            <li ng-repeat="cotd in card.reddit_cotds track by cotd.id">\n              <a ng-href="{{ cotd.url }}" target="reddit">\n                <i class="icon-cotd"></i> Card of the Day ({{ cotd.created|date }})\n              </a>\n            </li>\n            <li ng-if="card.cgdb_url != null">\n              <a ng-href="{{ card.cgdb_url }}#commentsStart" target="cgdb">\n                <i class="icon-link-ext"></i> Comments on CardGameDB\n              </a>\n            </li>\n            <!--li>\n              <a ng-href="{{ card.nrdb_url }}" target="nrdb">\n                <i class="icon-link-strength"></i> View on NetrunnerDB\n              </a>\n            </li-->\n          </ul>\n        </div>\n      </div>\n    </div>\n  </div>\n  <div class="card-pager">\n    <div class="card-pager-inner">\n      <span class="prev-card">\n        <a ng-click="selectPreviousCard()">Previous</a>\n      </span>\n      <span class="next-card">\n        <a ng-click="selectNextCard()">Next</a>\n      </span>\n      <div class="card-count">\n        <span class="current">{{ queryResult.cardOrdinal(card) + 1 }}</span>\n        of\n        <span class="total">{{ queryResult.length }}</span>\n      </div>\n    </div>\n  </div>\n</div>\n<div class="wing">\n  <div class="wing-click-region" ng-click="selectNextCard()"></div>\n  <div ng-repeat="card in cardsAfter track by card.id"\n       class="card-image in-wing next next-{{ $index }}">\n    <img ng-src="{{ card.imagesrc }}" width="300" height="418">\n    <div class="background"></div>\n  </div>\n</div>\n'),a.put("/views/directives/nr-cost-to-break-calculator.html",'<div class="controls opponent-type-{{ costToBreakInfo.opponentType | lowercase }}">\n  <div class="filters info-row">\n    <label class="info-label" for="opponent-filter">Filters:</label>\n    <div class="info-value">\n      <input ng-model="opponentFilter"\n             id="opponent-filter"\n             type="search"\n             class="opponent-filter input-sm form-control"\n             placeholder="Title / Faction"\n             filter-input>\n      <input ng-model="maxIceStrength"\n             ng-show="costToBreakInfo.opponentType == \'ICE\'"\n             type="number"\n             min="0"\n             class="max-ice-strength input-sm form-control"\n             placeholder="Max ICE Str."\n             filter-input>\n    </div>\n  </div>\n\n  <div class="adjustments info-row">\n    <label class="info-label" for="ice-adjust">Adjust:</label>\n    <div class="info-value">\n      <input ng-model="iceAdjust"\n             id="ice-adjust"\n             type="number"\n             class="ice-adjust input-sm form-control"\n             placeholder="ICE ⁺⁄₋"\n             filter-input>\n\n      <input ng-model="breakerStrength"\n             ng-show="card.variablestrength"\n             type="number"\n             min="0"\n             class="breaker-strength input-sm form-control"\n             placeholder="Breaker ⁺⁄₋"\n             filter-input>\n    </div>\n  </div>\n\n  <div class="stats-row">\n    <span class="stat-label">average:</span>\n    <span class="average-stat stat">{{ averageCredits | number:1 }}</span>\n    <span class="stat-label">median:</span>\n    <span class="median-stat stat">{{ medianCredits | number:1  }}</span>\n    <span class="stat-label">broken:</span>\n    <span class="broken-stat stat">{{ brokenCount }}</span>\n    <span class="stat-label">unbroken:</span>\n    <span class="unbroken-stat stat">{{ unbrokenCount }}</span>\n  </div>\n</div>\n\n<ul class="opponents list-unstyled">\n  <li ng-repeat="opponent in opponents"\n      class="opponent"\n      ng-class="{\n        \'not-broken\': !opponent.interaction.broken\n      }">\n    <div class="card">\n      <a ng-href="{{ opponent.card | cardUrl:\'card\' }}">{{ opponent.card.title }}</a>\n      <span ng-if="opponent.interaction.breakerCondition"\n            class="text-muted">\n        <span ng-if="costToBreakInfo.opponentType == \'ICE\'">\n          {{ card.title }}\n        </span>\n        <i class="icon-strength" title="Strength"></i>\n        {{ opponent.interaction.breakerCondition }}\n      </span>\n    </div>\n    <div class="cost">\n      {{ opponent.interaction.broken ? opponent.interaction.creditsSpent : \'⃠\' }}\n    </div>\n  </li>\n</ul>\n'),a.put("/views/directives/nr-nav.html",'<h1 class="brand" ng-click="resetState()">Ono-Sendai</h1>\n<nav>\n  <ul>\n    <li class="active">\n      <a href="#" tabindex="-1">\n        <span class="unabridged">Card Browser</span>\n        <span class="abbreviated">Cards</span>\n      </a>\n    </li>\n    <li>\n      <a href="#" tabindex="-1">\n        <span class="unabridged">Deck Builder</span>\n        <span class="abbreviated">Decks</span>\n\n        <div class="tooltip bottom">\n          <div class="tooltip-inner">\n            Coming soon...\n          </div>\n          <div class="tooltip-arrow"></div>\n        </div>\n      </a>\n    </li>\n  </ul>\n</nav>\n<div class="controls">\n  <div class="card-search">\n    <div class="abbreviated">\n      <a href="#"><i class="icon-search"></i></a>\n    </div>\n    <div class="dropdown-parent unabridged">\n      <input class="form-control"\n             type="search"\n             placeholder="Card Search"\n             ng-model="cardSearch"\n             ui-hotkey="cmd+F/ctrl+F"\n             ui-keydown="{\n               \'up\'    : { action: \'previousResult()\', preventDefault: true },\n               \'down\'  : { action: \'nextResult()\', preventDefault: true },\n               \'enter\' : { action: \'clearSearch()\', preventDefault: true }\n             }"\n             autofocus\n             filter-input>\n      <ul class="dropdown-menu">\n        <li ng-repeat="card in cardSearchResults"\n            ng-class="{\n              active: $index == cardSearchResults.selectedIndex\n            }">\n          <a href="{{ card | cardUrl:\'card\' }}" ng-bind-html="resultTitle(card, cardSearch)"></a>\n        </li>\n      </ul>\n    </div>\n  </div>\n</div>\n'),a.put("/views/directives/nr-numeric-filter.html",'<div class="input-group input-group-sm">\n  <div class="input-group-btn">\n    <button id="{{id}}-operator" type="button" class="btn btn-default dropdown-toggle"\n            dropdown-toggle\n            ng-disabled="uiDisabled" tabindex="-1">{{ filter.operator }} <span class="caret"></span></button>\n    <ul class="dropdown-menu" dropdown-menu>\n      <li ng-repeat="op in comparisonOperators">\n        <a ng-click="filter.operator = op" tabindex="-1">{{op}}</a>\n      </li>\n    </ul>\n  </div>\n  <input id="{{id}}-value" type="number" class="form-control"\n         ng-model="filter.value"\n         min="0"\n         max="{{max}}"\n         placeholder="{{placeholder}}"\n         ng-disabled="uiDisabled">\n</div>\n'),a.put("/views/directives/nr-subnav.html",'<nav>\n  <ul>\n    <li><a ng-model="filter.side" btn-radio="\'Corp\'">Corporation</a></li>\n    <li><a ng-model="filter.side" btn-radio="\'Runner\'">Runner</a></li>\n  </ul>\n</nav>\n<div class="zoom dropdown" ng-if="cardsUI.layoutMode == \'grid\'">\n  <span class="control-label">Zoom:</span>\n\n  <div class="unabridged">\n    <input type="range" step="0.003125" min="0.2" max="1.0"\n           ng-model="cardsUI.zoom"\n           ng-mousedown="broadcastZoomStart()"\n           ng-mouseup="broadcastZoomEnd()">\n  </div>\n  <div class="abbreviated">\n    <button class="btn btn-default dropdown-toggle" dropdown-toggle>\n      {{ (cardsUI.zoom * 100).toFixed() }}% <span class="caret"></span>\n    </button>\n    <div class="dropdown-menu" dropdown-menu>\n      <input type="range" step="0.003125" min="0.2" max="1.0"\n             ng-model="cardsUI.zoom"\n             ng-mousedown="broadcastZoomStart()"\n             ng-mouseup="broadcastZoomEnd()">\n    </div>\n  </div>\n</div>\n<div class="groupings">\n  <span class="control-label">Group:</span>\n  <div class="unabridged">\n    <div class="btn-group">\n      <button ng-repeat="grouping in groupingUI"\n              ng-model="filter.groupings"\n              btn-radio="grouping.groupings"\n              class="btn btn-default">{{ grouping.display }}</button>\n    </div>\n  </div>\n\n  <div class="abbreviated dropdown">\n    <button class="btn btn-default dropdown-toggle">Faction <span class="caret"></span></button>\n    <ul class="dropdown-menu">\n      <li ng-repeat="grouping in groupingUI">\n        <a href="#">{{ grouping.display }}</a>\n      </li>\n    </ul>\n  </div>\n</div>\n'),a.put("/views/filters.html",'<!--\nNOTES:\n* If deck building, in-faction-only option\n-->\n\n<div ng-controller="FiltersCtrl"\n     ui-keydown="{\n       \'enter\': \'clearFocus()\'\n     }"\n     class="form form-horizontal">\n\n  <div class="filter-group {{ group.name }}"\n       ng-repeat="group in filterUI"\n       ng-class="{ active: isActiveGroup(group, filter.activeGroup) }"\n       ng-show="isGroupShown(group, filter.side)">\n\n    <h5 ng-click="toggleGroup(group.name)">{{ group.display }}</h5>\n\n    <div class="filter-group-field {{ field.name }} form-group"\n         ng-repeat="field in group.fieldFilters"\n         ng-class="{ disabled: isFieldDisabled(field, group, filter.activeGroup, filter.side) }"\n         ng-show="isFieldShown(field, group, filter.activeGroup, filter.side)">\n\n      <label for="{{ labelledFieldId(field) }}" class="control-label">\n        <i class="icon-{{ field.icon }}"></i>\n      </label>\n\n      <div ng-switch on="field.type">\n        <div ng-switch-when="search">\n          <input type="search"\n                 id="{{ field.name }}-filter"\n                 class="form-control input-sm"\n                 ng-class="{\n                   \'has-input\': !!filter.search\n                 }"\n                 placeholder="{{ field.placeholder }}"\n                 ng-model="filter.search"\n                 filter-input>\n          <a class="clear-filter"\n             ng-click="filter.search = \'\'">&times;</a>\n        </div>\n\n        <div ng-switch-when="faction">\n          <div class="faction-filter btn-group"\n               ng-class="{\n                 \'has-input\': factionSelected\n               }">\n            <button\n                class="btn btn-default btn-sm"\n                ng-repeat="faction in field.side[filter.side.toLowerCase()]"\n                ng-model="filter.fieldFilters.faction[faction.model]"\n                ui-all-or-one-box="filter.fieldFilters.faction"\n                ui-all-or-one-box-field="{{ faction.model }}"\n                title="{{ faction.name }}">\n              {{ faction.abbr }}\n            </button>\n          </div>\n          <a class="clear-filter"\n             ng-click="clearFactions()">&times;</a>\n        </div>\n\n        <div ng-switch-when="numeric">\n          <numeric-filter\n            id="{{ field.name }}-filter"\n            ng-class="{\n              \'has-input\': !!filter.fieldFilters[field.name].value\n            }"\n            filter-attr="filter.fieldFilters[field.name]"\n            placeholder="{{ field.placeholder }}"\n            max="{{ field.max }}"\n            ui-disabled="{{ isFieldDisabled(field, group, filter.activeGroup, filter.side) }}"\n            filter-input>\n          </numeric-filter>\n          <a class="clear-filter"\n             ng-click="filter.fieldFilters[field.name].value = null">&times;</a>\n        </div>\n\n        <div ng-switch-when="inSet">\n          <inset-filter\n            id="{{ field.name }}-filter"\n            ng-class="{\n              \'has-input\': !!filter.fieldFilters[field.name]\n            }"\n            placeholder="{{ field.placeholder }}"\n            ng-model="filter.fieldFilters[field.name]"\n            inset-filter-source="this[field.source]"\n            filter-input>\n          </inset-filter>\n          <a class="clear-filter"\n             ng-click="filter.fieldFilters[field.name] = null">&times;</a>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>\n')}]),function(){angular.module("onoSendai").controller("CardsCtrl",["$scope","$http","$log","$q","cardService","userPreferences","urlStateService","queryArgDefaults",function(a,b,c,d,e,f,g,h){var i,j,k,l,m,n,o,p;return a.filter=g.queryArgs,i=function(b){var d,e,h,i,l;return d=b[0],e=b[1],a.cardsUI={zoom:null!=(i=f.zoom())?i:.5,layoutMode:"grid",cardPage:null!=(l=g.cardPage)?l:"info"},c.debug("Assigning cards with initial query ordering"),a.cards=e.applyOrdering(d,function(a){return a.id}),n(e),h=_.findWhere(d,{id:g.selectedCardId}),null!=h&&a.selectCard(h),j(),k(),m()},m=function(){return b.get("/data/version.json").success(function(b){return a.version=b.version})},d.all([e.getCards(),e.query(g.queryArgs)]).then(i),a.selectCard=function(b){return null!=b?(c.info("Selected card changing to "+b.title),a.cardsUI.layoutMode="detail"):c.info("Card deselected"),a.selectedCard=b,o()},a.deselectCard=function(){return a.cardsUI.layoutMode="grid",a.selectCard(null)},a.selectPreviousCard=function(){var b;if(null!==a.selectedCard&&(b=a.queryResult.cardBefore(a.selectedCard),null!=b))return c.info("Moving to previous card"),a.selectCard(b)},a.selectNextCard=function(){var b;if(null!==a.selectedCard&&(b=a.queryResult.cardAfter(a.selectedCard),null!=b))return c.info("Moving to next card"),a.selectCard(b)},a.$watch("cardsUI.layoutMode",l=function(b){return a.$broadcast("layout",b)}),n=function(b){var d,e;return c.debug("Assigning new query result",b),a.queryResult=b,d=null!=(e=a.selectedCard)?e:{},"detail"!==a.cardsUI.layoutMode||b.isShown(d.id)?void 0:a.selectCard(b.orderedCards[0])},j=function(){var b;return a.$watch("filter",b=function(a){return o(),e.query(a).then(function(a){return n(a)})},!0)},a.resetState=function(){return a.deselectCard(),a.filter=_.extend(angular.copy(h),{side:a.filter.side}),p(!0)},k=function(){var b;return a.$on("urlStateChange",b=function(){var b,c;return a.filter=g.queryArgs,c=null!=g.selectedCardId?b=_.findWhere(a.cards,{id:g.selectedCardId}):null,null!=c?a.selectCard(c):(a.deselectCard(),a.cardsUI.layoutMode="grid")})},p=function(b){var c,d;return null==b&&(b=!1),d=a.selectedCard,c=a.cardsUI.cardPage,a.$safeApply(function(){return g.updateUrl(a.filter,d,d&&c,b)})},o=_.debounce(p,500),a.broadcastZoomStart=function(){return a.$broadcast("zoomStart")},a.broadcastZoomEnd=function(){return a.$broadcast("zoomEnd"),f.zoom(a.cardsUI.zoom)}}])}.call(this),function(){angular.module("onoSendai").controller("FiltersCtrl",["$scope","filterUI","cardService",function(a,b,c){var d,e,f,g,h,i;return a.filterUI=b,e=a.filter.fieldFilters.faction,c.getSets().then(d=function(b){var c,d;return c=(new Date).getTime(),d=_.filter(b,function(a){return null!=a.released?new Date(a.released).getTime()<c:!1}),a.sets=_.map(d,function(a){return{id:a.id,text:a.title}})}),c.ready().then(i=function(){var b;return b=c.subtypes[a.filter.side.toLowerCase()],a.subtypes=_.map(b,function(a){return{id:a.id,text:a.title}})}),a.$watch("filter.side",h=function(b,c){return b!==c?(a.filter.activeGroup="general",a.clearFactions(),delete a.filter.fieldFilters.subtype,i()):void 0}),a.$watch("filter.fieldFilters.faction",f=function(){return a.factionSelected=_.any(e,function(a){return!a})},!0),g=function(a){return _.findWhere(b,{name:a})},a.clearFactions=function(){var a,b,c;c=[];for(a in e)b=e[a],c.push(e[a]=!0);return c},a.labelledFieldId=function(a){switch(a.type){case"numeric":return""+a.name+"-filter-operator";case"search":case"inSet":return""+a.name+"-filter"}},a.toggleGroup=function(b){return a.filter.activeGroup=a.filter.activeGroup!==b?b:"general"},a.isActiveGroup=function(a,b){return b?a.name===b:!1},a.isGroupShown=function(a,b){return null!=a.side?a.side===b:!0},a.isFieldShown=function(a,b,c,d){return"general"===b.name||c===b.name&&(void 0===a.side||a.side===d)},a.isFieldDisabled=function(a,b,c){var d;return"general"===b.name&&(null!=(d=g(c).hiddenGeneralFields)?d[a.name]:void 0)}}])}.call(this),function(){var a,b,c=function(a,b){return function(){return a.apply(b,arguments)}},d=[].slice;b=function(){function a(){this.orderedCards=[],this.orderingById={},this.groups={},this.length=0,this._ordinalOffset=0}var b;return a.prototype.addCard=function(a,b,c){return this.orderedCards.push(a),this.length++,null==this.orderingById[b.id]&&(this.orderingById[b.id]=c+this._ordinalOffset,this.groups[b.id]=b,this._ordinalOffset++),this.orderingById[a.id]=c+this._ordinalOffset},a.prototype.isShown=function(a){return null!=this.orderingById[a]},a.prototype.applyOrdering=function(a,b){var c=this;return _.sortBy(a,function(a){var d;return null!=(d=c.orderingById[b(a)])?d:Number.MAX_VALUE})},a.prototype.cardOrdinal=function(a){return this.orderedCards.indexOf(a)},b=function(a){return function(b){var c;return c=this.orderedCards.indexOf(b)+a,this.orderedCards[c]}},a.prototype.cardAfter=b(1),a.prototype.cardBefore=b(-1),a.prototype.beforeAndAfter=function(a,b){var c,d,e,f;return e=this.orderedCards.indexOf(a),-1===e?[[],[]]:(d=this.orderedCards.slice(Math.max(0,e-b),e),c=this.orderedCards.slice(f=e+1,f+b),[d,c])},a}(),a=function(){function a(a,b,d,f){var g=this;this.$log=b,this.searchService=d,this.filterDescriptors=f,this._initSubtypes=c(this._initSubtypes,this),this._augmentSets=c(this._augmentSets,this),this._augmentCards=c(this._augmentCards,this),this._sortFnFor=c(this._sortFnFor,this),this._groupCards=c(this._groupCards,this),this._buildCardSetFilter=c(this._buildCardSetFilter,this),this._buildFilterFunction=c(this._buildFilterFunction,this),this.relevantFilters=c(this.relevantFilters,this),this._enabledTypes=c(this._enabledTypes,this),this._matchesFilter=c(this._matchesFilter,this),this._filterCards=c(this._filterCards,this),this._searchCards=c(this._searchCards,this),this._cards=[],this._sets=[],this._setsByTitle={},this._setsById={},this.subtypeCounts={corp:{},runner:{}},this.subtypes={corp:[],runner:[]},this._cardsPromise=a.get(e).then(function(a){var b,c,d,e;return e=a.data,g._sets=e.sets,g._cards=e.cards,c=e["last-modified"],d=a.status,b=a.headers,window.cards=g._cards,g.searchService.indexCards(g._cards,c),g._augmentCards(g._cards),g._augmentSets(g._sets),g._initSubtypes(),g._cards})}var e,f,g,h;return e="/data/cards.json",f={Identity:0,Event:1,Hardware:2,Program:3,Resource:4,Agenda:5,Asset:6,Operation:7,ICE:8,Upgrade:9},g={Anarch:0,Criminal:1,"Haas-Bioroid":2,Jinteki:3,NBN:4,Shaper:5,"Weyland Consortium":6,Neutral:7},h={and:function(){var a,b,c,e,f;for(c=arguments[0],a=2<=arguments.length?d.call(arguments,1):[],e=0,f=c.length;f>e;e++)if(b=c[e],!b.apply(null,a))return!1;return!0},"=":function(a,b){return a===b},"≠":function(a,b){return a!==b},"<":function(a,b){return b>a},"≤":function(a,b){return b>=a},">":function(a,b){return a>b},"≥":function(a,b){return a>=b}},a.prototype.comparisonOperators=[{display:"=",typed:"=="},{display:"≠",typed:"!="},{display:"<",typed:"<"},{display:"≤",typed:"<="},{display:">",typed:">"},{display:"≥",typed:">="}],a.prototype.ready=function(){return this._cardsPromise},a.prototype.getCards=function(){return this._cardsPromise},a.prototype.getSets=function(){var a=this;return this._cardsPromise.then(function(){return a._sets})},a.prototype.getSetByTitle=function(a){return this._setsByTitle[a]},a.prototype.query=function(a){var b=this;return null==a&&(a={}),null==a.fieldFilters&&(a.fieldFilters={}),this._cardsPromise.then(function(c){return _.logGroup("Card query",_.timed("Query duration",function(){var d,e,f;return b.$log.debug("Args:",a),d=b._filterCards(a,b._searchCards(a,c)),e=b._groupCards(a,d),f=b._buildQueryResult(a,e),b.$log.debug("Cards matching query: "+f.length),f}))})},a.prototype._searchCards=function(a){var b,c;return c=a.search,b=a.byTitle,_.trim(c).length>0?this.searchService.search(c,b):this._cards},a.prototype._filterCards=function(a,b){var c,d,e,f,g,h;for(d=this._enabledTypes(a),e=this._buildFilterFunction(a,d),h=[],f=0,g=b.length;g>f;f++)c=b[f],this._matchesFilter(c,a,{enabledTypes:d,filterFn:e})&&h.push(c);return h},a.prototype._matchesFilter=function(a,b,c){var d,e;return d=c.enabledTypes,e=c.filterFn,(null!=b.side?a.side===b.side:!0)&&(null!=d?d[a.type]:!0)&&(null!=e?e(a):!0)},a.prototype._enabledTypes=function(a){var b,c,d;return b=a.activeGroup,null==b||"general"===b?null:(c=this.filterDescriptors[b].cardType,d={},d[c]=!0,d)},a.prototype.relevantFilters=function(a,b){var c,d,e=this;return null==b&&(b=!0),d=["general"],c={},null!=a.activeGroup&&"general"!==a.activeGroup&&(d.push(a.activeGroup),c=this.filterDescriptors[a.activeGroup].excludedGeneralFields||{}),_(d).chain().map(function(a){return e.filterDescriptors[a]}).filter(function(a){return null!=a.fieldFilters}).pluck("fieldFilters").map(function(d){return _.filterObj(d,function(d,f){var g;return g=a.fieldFilters[d],null==c[d]&&(!b||e._isFilterApplicable(f,g,a))})}).map(_.pairs).flatten(!0).object().value()},a.prototype._isFilterApplicable=function(a,b,c){switch(a.type){case"numeric":return null!=b&&null!=b.operator&&null!=b.value;case"search":return null!=c.search&&!!c.search.length;default:return!(null==b||_.isString(b)&&!b.length)}},a.prototype._buildFilterFunction=function(a){var b,c,d=this;return c=this.relevantFilters(a),_.isEmpty(c)?void 0:(b=_(c).chain().map(function(b,c){return d._buildFilter(b,a.fieldFilters[c])}).compact().value(),_.partial(h.and,b))},a.prototype._buildFilter=function(a,b){switch(a.type){case"numeric":return this._buildNumericFilter(a,b);case"inSet":return this._buildInSetFilter(a,b);case"cardSet":return this._buildCardSetFilter(a,b);case"search":return void 0;default:return console.warn("Unknown filter type: "+a.type)}},a.prototype._buildNumericFilter=function(a,b){return function(c){var d,e,f,g,i;for(d=_.isArray(a.cardField)?a.cardField:[a.cardField],g=0,i=d.length;i>g;g++)if(e=d[g],null!=c[e])return f=c[e],h[b.operator](f,b.value);return!1}},a.prototype._buildInSetFilter=function(a,b){return function(c){var d;switch(d="faction"===a.cardField?""+c.side+": "+c.faction:c[a.cardField],a.subtype){case"boolSet":return b[d];default:return d[b]}}},a.prototype._buildCardSetFilter=function(a,b){var c;return c=this._setsById[b],function(a){return a.setname===c.title}},a.prototype._groupCards=function(a,b){var c,d,e;return c=a.groupings,d=_(c).chain().concat(["title"]).map(this._sortFnFor).value(),(e=_(b).chain()).multiSort.apply(e,d).groupBy(function(a){return _.map(c,function(b){return a[b]})}).pairs().map(function(a){return{id:a[0].replace(/,/g," ").toLowerCase(),title:a[0].split(","),cards:a[1]}}).value()},a.prototype._buildQueryResult=function(a,c){var d,e;return d=0,e=new b,_.each(c,function(a){return _.each(a.cards,function(b){return e.addCard(b,a,d++)})}),e},a.prototype._sortFnFor=function(a){var b=this;switch(a){case"type":return function(a,b){return f[a.type]-f[b.type]};case"faction":return function(a,b){return g[a.faction]-g[b.faction]};case"cost":case"factioncost":return function(b,c){return void 0===b[a]||void 0===c[a]?0:b[a]-c[a]};case"setname":return function(a,c){return b._setsByTitle[a.setname].ordinal-b._setsByTitle[c.setname].ordinal};default:return function(b,c){return b[a].localeCompare(c[a])}}},a.prototype._augmentCards=function(a){var b=this;return _.each(a,function(a){var c,d,e,f,g,h,i,j;for(a.id=_.idify(a.title),a.subtypes=null!=a.subtype?a.subtype.split(/\s+[-\u2013\ufe58]\s+/g):[],e=_.map(a.subtypes,_.idify),a.subtypesSet=_.object(e,_.times(e.length,function(){return!0})),c=a.side.toLowerCase(),i=a.subtypes,g=0,h=i.length;h>g;g++)d=i[g],null==(f=b.subtypeCounts[c])[d]&&(f[d]=0),b.subtypeCounts[c][d]++;switch(a.type){case"ICE":return a.subroutinecount=(null!=(j=a.text.match(/\[Subroutine\]/g))?j.length:void 0)||0;case"Identity":return delete a.cost}})},a.prototype._augmentSets=function(a){var b=this;return _.each(a,function(a,c){return a.id=_.idify(a.title),a.ordinal=c,b._setsByTitle[a.title]=a,b._setsById[a.id]=a})},a.prototype._initSubtypes=function(){return this.subtypes=_.object(_.map(this.subtypeCounts,function(a,b){var c;return c=_(a).chain().keys().sort().map(function(a){return{id:_.idify(a),title:a}}).value(),[b,c]}))},a}(),angular.module("onoSendai").service("cardService",["$http","$log","searchService","filterDescriptors",function(){return function(a,b,c){c.prototype=a.prototype;
var d=new c,e=a.apply(d,b);return Object(e)===e?e:d}(a,arguments,function(){})}])}.call(this),function(){angular.module("onoSendai").value("queryArgDefaults",{side:"Corp",search:"",activeGroup:"general",groupings:["faction","type"],fieldFilters:{faction:{"Corp: Haas-Bioroid":!0,"Corp: Jinteki":!0,"Corp: NBN":!0,"Corp: Weyland Consortium":!0,"Corp: Neutral":!0,"Runner: Anarch":!0,"Runner: Criminal":!0,"Runner: Shaper":!0,"Runner: Neutral":!0},subtype:null,cost:{operator:"="},factionCost:{operator:"="},setname:null,influenceLimit:{operator:"="},minimumDeckSize:{operator:"="},points:{operator:"="},assetTrashCost:{operator:"="},subroutineCount:{operator:"="},iceStrength:{operator:"="},influence:{operator:"="},upgradeTrashCost:{operator:"="},memoryUnits:{operator:"="},baseLink:{operator:"="}}}).constant("filterUI",[{name:"general",display:"general",fieldFilters:[{name:"faction",type:"faction",icon:"faction",side:{corp:[{name:"Haas-Bioroid",abbr:"HB",model:"Corp: Haas-Bioroid"},{name:"Jinteki",abbr:"J",model:"Corp: Jinteki"},{name:"NBN",abbr:"NBN",model:"Corp: NBN"},{name:"Weyland Consortium",abbr:"W",model:"Corp: Weyland Consortium"},{name:"Neutral",abbr:"N",model:"Corp: Neutral"}],runner:[{name:"Anarch",abbr:"A",model:"Runner: Anarch"},{name:"Criminal",abbr:"C",model:"Runner: Criminal"},{name:"Shaper",abbr:"S",model:"Runner: Shaper"},{name:"Neutral",abbr:"N",model:"Runner: Neutral"}]}},{name:"search",type:"search",placeholder:"Keyword Search",icon:"search"},{name:"subtype",type:"inSet",placeholder:"Subtype",icon:"subtype",source:"subtypes"},{name:"cost",type:"numeric",placeholder:"Cost",icon:"credit"},{name:"factionCost",type:"numeric",placeholder:"Influence",icon:"influence",max:5},{name:"setname",type:"inSet",placeholder:"Set",icon:"set",source:"sets"}]},{name:"identity",display:"identities",hiddenGeneralFields:{cost:!0,factionCost:!0},fieldFilters:[{name:"influenceLimit",type:"numeric",placeholder:"Influence Limit",icon:"influence"},{name:"minimumDeckSize",type:"numeric",placeholder:"Min. Deck Size",icon:"minimum-deck-size"},{side:"Runner",name:"baseLink",type:"numeric",placeholder:"Base Link",icon:"link-strength"}]},{name:"agenda",display:"agendas",side:"Corp",fieldFilters:[{name:"points",type:"numeric",placeholder:"Agenda Points",icon:"agenda-point"}]},{name:"asset",display:"assets",side:"Corp",fieldFilters:[{name:"assetTrashCost",type:"numeric",placeholder:"Trash Cost",icon:"trash-cost"}]},{name:"operation",display:"operations",side:"Corp"},{name:"ice",display:"ice",side:"Corp",fieldFilters:[{name:"subroutineCount",type:"numeric",placeholder:"# Subroutines",icon:"subroutine"},{name:"iceStrength",type:"numeric",placeholder:"Strength",icon:"strength"}]},{name:"upgrade",display:"upgrades",side:"Corp",fieldFilters:[{name:"upgradeTrashCost",type:"numeric",placeholder:"Trash Cost",icon:"trash-cost"}]},{name:"event",display:"events",side:"Runner"},{name:"hardware",display:"hardware",side:"Runner"},{name:"program",display:"programs",side:"Runner",fieldFilters:[{name:"memoryUnits",type:"numeric",placeholder:"Memory Units",icon:"memory-unit"}]},{name:"resource",display:"resources",side:"Runner"}]).constant("filterDescriptors",{general:{fieldFilters:{faction:{type:"inSet",subtype:"boolSet",cardField:"faction"},search:{type:"search"},cost:{type:"numeric",cardField:["advancementcost","cost"]},factionCost:{type:"numeric",cardField:"factioncost"},setname:{type:"cardSet",cardField:"setname"},subtype:{type:"inSet",cardField:"subtypesSet"}}},identity:{cardType:"Identity",excludedGeneralFields:{cost:!0,factionCost:!0},fieldFilters:{influenceLimit:{type:"numeric",cardField:"influencelimit"},minimumDeckSize:{type:"numeric",cardField:"minimumdecksize"},baseLink:{type:"numeric",cardField:"baselink",inclusionPredicate:function(a){return"Runner"===a.side}}}},ice:{cardType:"ICE",fieldFilters:{subroutineCount:{type:"numeric",cardField:"subroutinecount"},iceStrength:{type:"numeric",cardField:"strength"}}},agenda:{cardType:"Agenda",fieldFilters:{points:{type:"numeric",cardField:"agendapoints"}}},asset:{cardType:"Asset",fieldFilters:{assetTrashCost:{type:"numeric",cardField:"trash"}}},operation:{cardType:"Operation"},upgrade:{cardType:"Upgrade",fieldFilters:{upgradeTrashCost:{type:"numeric",cardField:"trash"}}},event:{cardType:"Event"},hardware:{cardType:"Hardware"},program:{cardType:"Program",fieldFilters:{memoryUnits:{type:"numeric",cardField:"memoryunits"}}},resource:{cardType:"Resource"}}).constant("groupingUI",[{display:"Faction",groupings:["faction","type"]},{display:"Type",groupings:["type"]},{display:"Cost",groupings:["cost"]},{display:"Influence",groupings:["factioncost"]},{display:"Set",groupings:["setname"]}])}.call(this),function(){var a,b,c=function(a,b){return function(){return a.apply(b,arguments)}};b=function(){function a(a,b,d,e){var f=this;this.$log=a,this.cardService=d,this.breakScripts=e,this.calculate=c(this.calculate,this),this.isCardApplicable=c(this.isCardApplicable,this),b.all({sentry:this._performQuery("Corp","ice","sentry"),barrier:this._performQuery("Corp","ice","barrier"),"code-gate":this._performQuery("Corp","ice","code-gate"),allIce:this._performQuery("Corp","ice"),killer:this._performQuery("Runner","program","killer"),fracter:this._performQuery("Runner","program","fracter"),decoder:this._performQuery("Runner","program","decoder"),ai:this._performQuery("Runner","program","ai")}).then(function(a){return f._sentries=a.sentry,f._barriers=a.barrier,f._codeGates=a["code-gate"],f._allIce=a.allIce,f._killers=a.killer,f._fracters=a.fracter,f._decoders=a.decoder,f._ais=a.ai,f.$log.debug("Cost to Break queries complete")})}return a.prototype.isCardApplicable=function(a){return"ICE"===a.type||"icebreaker"in a.subtypesSet},a.prototype.calculate=function(a,b,c){var d=this;return this.isCardApplicable(a)?_.logGroup("Cost to break for "+a.title,_.timed("Calculation time",function(){return"ICE"===a.type?d._calculateForIce(a,b,c):"Program"===a.type?d._calculateForIcebreaker(a,b,c):void 0})):(this.$log.warn(""+a.title+" does not have a cost to break calculation, because it isn't ICE or a breaker"),void 0)},a.prototype._calculateForIce=function(a,b,c){var d,e=this;return d=[],this._validIceAdjust(b)&&(a=_.extend(angular.copy(a),{originalstrength:a.strength,strength:a.strength+b})),a.subtypesSet.sentry&&(d=d.concat(this._killers.orderedCards)),a.subtypesSet.barrier&&(d=d.concat(this._fracters.orderedCards)),a.subtypesSet["code-gate"]&&(d=d.concat(this._decoders.orderedCards)),d=d.concat(this._ais.orderedCards),{opponentType:"Icebreakers",opponents:_.map(_.sortBy(d,"title"),function(b){return{card:b,interaction:e._calculateInteraction(a,b,c)}})}},a.prototype._calculateForIcebreaker=function(a,b,c){var d,e=this;return d=[],a.subtypesSet.killer&&(d=d.concat(this._sentries.orderedCards)),a.subtypesSet.fracter&&(d=d.concat(this._barriers.orderedCards)),a.subtypesSet.decoder&&(d=d.concat(this._codeGates.orderedCards)),a.subtypesSet.ai&&(d=d.concat(this._allIce.orderedCards)),null!=a.breakcardsscript&&(d=d.concat(this.breakScripts[a.breakcardsscript](a,this._allIce.orderedCards))),this._validIceAdjust(b)&&(d=_.map(d,function(a){return _.extend(angular.copy(a),{originalstrength:a.strength,strength:a.strength+b})})),{opponentType:"ICE",opponents:_.map(_.sortBy(d,"title"),function(b){return{card:b,interaction:e._calculateInteraction(b,a,c)}})}},a.prototype._calculateInteraction=function(a,b,c){var d,e,f,g,h,i;if(g={credits:0,broken:!1,steps:[]},h=_.isNumber(b.strengthcost)?{credits:b.strengthcost,strength:1}:b.strengthcost,d=b.breakcost,null!=b.breakscript&&(a=angular.copy(a),b=angular.copy(b),e=this.breakScripts[b.breakscript],e(g,b,h,d,a,c)===!0))return g;if(f=g.credits,i=a.strength,i-=b.strength,i>0&&null==h)return _.extend(g,{reason:"Fixed breaker, strength too low"});for(;i>0;)f+=h.credits,i-=h.strength;return f+="all"===d.subroutines?d.credits:Math.ceil(a.subroutinecount/d.subroutines)*d.credits,_.extend(g,{broken:!0,creditsSpent:f})},a.prototype._validIceAdjust=function(a){return _.isNumber(a)&&0!==a},a.prototype._performQuery=function(a,b,c){return this.cardService.query({side:a,activeGroup:{name:b},fieldFilters:{subtype:c}})},a}(),a=function(){function a(){this._handleAntiAI=c(this._handleAntiAI,this),this.wyrm=c(this.wyrm,this),this.sharpshooterCards=c(this.sharpshooterCards,this),this.deusxCards=c(this.deusxCards,this),this.darwin=c(this.darwin,this),this.genericAI=c(this.genericAI,this),this.atman=c(this.atman,this)}return a.prototype.atman=function(a,b,c,d,e,f){var g;return g=(null!=f?f:{}).breakerStrength,this._handleAntiAI(a,e)?!0:e.strength<0?(a.reason="ICE strength too low",!0):null!=g?e.strength!==g?(a.reason="Strengths are not equal",!0):(b.strength=g,!1):(a.breakerCondition="= "+e.strength,b.strength=e.strength)},a.prototype.genericAI=function(a,b,c,d,e){return this._handleAntiAI(a,e)?!0:void 0},a.prototype.darwin=function(a,b,c,d,e,f){var g;return g=(null!=f?f:{}).breakerStrength,this._handleAntiAI(a,e)?!0:null!=g?b.strength=g:(b.strength=Math.max(e.strength,0),a.breakerCondition="≥ "+b.strength)},a.prototype.deusxCards=function(a,b){return _.filter(b,function(a){return a.subtypesSet.ap})},a.prototype.sharpshooterCards=function(a,b){return _.filter(b,function(a){return a.subtypesSet.destroyer})},a.prototype.wyrm=function(a,b,c,d,e){return this._handleAntiAI(a,e)?!0:(a.credits+=e.strength,!1)},a.prototype._handleAntiAI=function(a,b){return"swordsman"===b.id?(a.reason="AI icebreakers cannot be used against this ICE",!0):!1},a}(),angular.module("onoSendai").service("costToBreakCalculator",["$log","$q","cardService","breakScripts",function(){return function(a,b,c){c.prototype=a.prototype;var d=new c,e=a.apply(d,b);return Object(e)===e?e:d}(b,arguments,function(){})}]).value("breakScripts",new a)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}};a=function(){function a(){this._persistFavourites=b(this._persistFavourites,this),this.zoom=b(this.zoom,this),this.toggleCardFavourite=b(this.toggleCardFavourite,this),this.isCardFavourite=b(this.isCardFavourite,this);var a;this._favs=null!=(a=JSON.parse(localStorage.getItem("favourites")+""))?a:{}}return a.prototype.isCardFavourite=function(a){var b;return null!=(b=this._favs[a.id])?b:!1},a.prototype.toggleCardFavourite=function(a){return this._favs[a.id]=!this.isCardFavourite(a),this._persistFavourites()},a.prototype.zoom=function(a){return null!=a?localStorage.setItem("zoom",a):localStorage.getItem("zoom")},a.prototype._persistFavourites=function(){return localStorage.setItem("favourites",JSON.stringify(this._favs))},a}(),angular.module("onoSendai").service("userPreferences",function(){return function(a,b,c){c.prototype=a.prototype;var d=new c,e=a.apply(d,b);return Object(e)===e?e:d}(a,arguments,function(){})})}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}};a=function(){function a(a){var c,d,e,f,g,h;for(this.$q=a,this._tokenize=b(this._tokenize,this),this._indexCards=b(this._indexCards,this),this._mapResultsToCards=b(this._mapResultsToCards,this),this.search=b(this.search,this),this.indexCards=b(this.indexCards,this),c=[{lbl:"stripDiacritics",fn:_.stripDiacritics}],f=0,g=c.length;g>f;f++)h=c[f],e=h.lbl,d=h.fn,lunr.Pipeline.registerFunction(d,e);lunr.tokenizer=this._tokenize,this._fullIndex=lunr(function(){var a,b;for(a=0,b=c.length;b>a;a++)d=c[a].fn,this.pipeline.before(function(){},d);return this.ref("title"),this.field("title",{boost:10}),this.field("type"),this.field("subtype"),this.field("text"),this.field("setname")}),this._titleIndex=lunr(function(){var a,b;for(a=0,b=c.length;b>a;a++)d=c[a].fn,this.pipeline.before(function(){},d);return this.ref("title"),this.field("title")})}return a.prototype.indexCards=function(a,b){var c=this;return this.cards=a,this._cardsByTitle=_.object(_.zip(_.pluck(a,"title"),a)),_.time("Indexing cards",function(){return c._tryCachedIndexes(_.partial(c._indexCards,a),b)})},a.prototype.search=function(a,b){var c;return null==b&&(b=!1),c=b?this._titleIndex:this._fullIndex,this._mapResultsToCards(c.search(a))},a.prototype._mapResultsToCards=function(a){var b,c,d,e;if(null==a)return[];for(e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(this._cardsByTitle[b.ref]);return e},a.prototype._tryCachedIndexes=function(a,b){var c,d,e,f,g;c=JSON.parse(localStorage.getItem("searchIndexes"));{if(null==c||null==c[b])return a(),e={},e[b]={_titleIndex:this._titleIndex.toJSON(),_fullIndex:this._fullIndex.toJSON()},localStorage.setItem("searchIndexes",JSON.stringify(e));g=c[b];for(f in g)d=g[f],this[f]=lunr.Index.load(d)}},a.prototype._indexCards=function(){var a,b,c,d,e,f,g,h,i;for(g=[this._titleIndex,this._fullIndex],i=[],c=0,e=g.length;e>c;c++){for(b=g[c],h=this.cards,d=0,f=h.length;f>d;d++)a=h[d],b.add(a);i.push(b.pipeline.remove(lunr.stopWordFilter))}return i},a.prototype._tokenize=function(a){return arguments.length&&null!=a?_.isArray(a)?a.map(function(a){return a.toLowerCase()}):_(a.toString()).chain().replace(/[\[\]{}'"]/g," ").stripTags().words().map(function(a){return a.split("-")}).flatten().map(function(a){return a.replace(/[^\w\d\s]+$/," ").replace(/^[^\w\d\s]+/," ").trim()}).value():[]},a}(),angular.module("onoSendai").service("searchService",["$q",function(b){return new a(b)}])}.call(this),function(){var a;a=function(){function a(a,c,d){this.$window=a,this.$q=c,this.$log=d,this.div=this.$window.document.createElement("div"),this.transitionProperty=this.getVendorPropertyName("transition"),this.transitionEndEvent=b[this.transitionProperty]}var b;return b={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",transition:"transitionend"},a.prototype.getVendorPropertyName=_.memoize(function(a){var b,c,d,e,f;if(a in this.div.style)return a;if(c=["Moz","Webkit","O","ms"],a=_.capitalize(a),a in this.div.style)return a;for(e=0,f=c.length;f>e;e++)if(b=c[e],d=b+a,d in this.div.style)return d}),a.prototype.cssDurationToMs=function(a){var b;return(b=a.match(/(\d+)ms/))?Number(b[1]):(b=a.match(/(\d+(\.\d+)?)s/))?1e3*Number(b[1]):void 0},a.prototype.cssPixelLengthToNumber=function(a){var b;return a?(b=a.match(/^(\d+(\.\d+)?)/),Number(b[1])):0},a.prototype.getTransitionDuration=function(a,b){var c;return null==b&&(b=this.$window.getComputedStyle(this._node(a))),c=b[this.transitionProperty].split(/\s+/),this.cssDurationToMs(c[1])+this.cssDurationToMs(c[3])},a.prototype.getTransitionEndPromise=function(a){var b,c,d=this;return b=this.$q.defer(),a.one(this.transitionEndEvent,c=function(){return d.$log.debug("Transition complete"),b.resolve()}),b.promise},a.prototype._node=function(a){return a instanceof $?a.get(0):a},a}(),angular.module("onoSendai").service("cssUtils",["$window","$q","$log",function(b,c,d){return new a(b,c,d)}])}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}};a=function(){function a(a,c,d,e,f,g){var h,i;this.$rootScope=a,this.$location=c,this.$log=d,this.cardService=e,this.filterUI=f,this.queryArgDefaults=g,this._locationChanged=b(this._locationChanged,this),this.generatedUrl=void 0,this.$rootScope.$on("$locationChangeSuccess",this._locationChanged),h=_.find(this.filterUI,function(a){return"general"===a.name}).fieldFilters,this.factionUiMappingsBySide=_.find(h,function(a){return"faction"===a.name}).side,i=this._stateFromUrl(),this.queryArgs=i[0],this.selectedCardId=i[1],this.cardPage=i[2]}var c,d;return c={"=":"eq","≠":"neq","<":"lt","≤":"lte",">":"gt","≥":"gte"},d=_.invert(c),a.prototype.updateUrl=function(a,b,d,e){var f,g,h,i,j,k,l,m,n,o,p,q;null==a&&(a=this.queryArgs),null==e&&(e=!1),this.$log.debug("Updating URL with latest query arguments"),n="/cards/"+a.side.toLowerCase(),"general"!==a.activeGroup&&(h=_.findWhere(this.filterUI,{name:a.activeGroup}),n+="/"+h.display),null!=b&&(n+="/card/"+b.id),d&&"cost-to-break"===d&&(n+="/$"),l={},q=this.cardService.relevantFilters(a);for(i in q)switch(g=q[i],f=a.fieldFilters[i],g.type){case"numeric":p=f.value,o=c[f.operator],l[i]=""+o+":"+p;break;case"inSet":m="faction"===i?(k=this.factionUiMappingsBySide[a.side.toLowerCase()],this._factionSearchVal(k,f)):_.isArray(f)?f.join(","):f,m&&(l[i]=m);break;case"search":l.search=a.search;break;default:l[i]=f}return angular.equals(a.groupings,["faction","type"])||(l.group=a.groupings.join(",")),this.$location.url(n).search(l),j=null==b&&null!=this.selectedCardId||null!=b&&null==this.selectedCardId||this.queryArgs.side!==a.side,j||e||this.$location.replace(),this.generatedUrl=this.$location.url(),this.queryArgs=angular.copy(a),this.selectedCardId=null!=b?b.id:void 0},a.prototype._factionSearchVal=function(a,b){return _.every(a,function(a){return b[a.model]})?void 0:_(a).chain().filter(function(a){return b[a.model]}).pluck("abbr").value().join(",")},a.prototype._locationChanged=function(){var a;if(this.$location.url()!==this.generatedUrl)return this.$log.debug("URL changed to "+this.$location.url()),a=this._stateFromUrl(),this.queryArgs=a[0],this.selectedCardId=a[1],this.cardPage=a[2],this.$rootScope.$broadcast("urlStateChange")},a.prototype._cardsUrlMatcher=/^\/cards\/(corp|runner)(?:\/([^c][^\/]+))?(?:\/card\/([^\/]+)(?:\/([^\/]))?)?/,a.prototype._stateFromUrl=function(){var a,b,c,e,f,g,h,i,j,k,l,m,n,o,p,q,r;if(m=null,a=null,i=angular.copy(this.queryArgDefaults),i.activeGroup="general",b=this.$location.path().match(this._cardsUrlMatcher),null==b)return this.$log.debug("No matching URL pattern. Assigning query arg defaults"),[i,void 0];if(n=b[1],i.side=_.capitalize(n),b[2]&&(i.activeGroup=null!=(p=null!=(q=_.findWhere(this.filterUI,{display:b[2]}))?q.name:void 0)?p:i.activeGroup),b[3]&&(m=b[3]),b[4])switch(b[4].trim()){case"$":a="cost-to-break"}k=this.cardService.relevantFilters(i,!1),l=this.$location.search();for(g in k)if(c=k[g],null!=l[g])switch(c.type){case"search":i.search=l.search;break;case"numeric":if(r=l[g].split(":"),h=r[0],o=r[1],null==o||null==h||null==d[h])break;i.fieldFilters[g]={operator:d[h],value:Number(o)};break;case"inSet":"faction"===g?(j=i.fieldFilters.faction,e=this.factionUiMappingsBySide[n],f=_.object(_.map(l[g].split(","),function(a){var b;return null!=(b=_.findWhere(e,{abbr:a}))?b.model:void 0}),[]),delete f.undefined,0!==_.keys(f).length&&_.each(j,function(a,b){return j[b]=b in f})):i.fieldFilters[g]=l[g];break;default:i.fieldFilters[g]=l[g]}return l.group&&(i.groupings=l.group.split(",")),[i,m,a]},a}(),angular.module("onoSendai").service("urlStateService",["$rootScope","$location","$log","cardService","filterUI","queryArgDefaults",function(){return function(a,b,c){c.prototype=a.prototype;var d=new c,e=a.apply(d,b);return Object(e)===e?e:d}(a,arguments,function(){})}]).run(["$rootScope","$location",function(a,b){return a.$on("$locationChangeSuccess",function(){return ga("send","pageview",{page:b.path()})})}])}.call(this),function(){angular.module("onoSendai").controller("CardViewCtrl",["$scope","costToBreakCalculator","userPreferences","urlStateService",function(a,b,c,d){var e,f,g,h,i,j;return a.cardUI={page:null!=(j=d.cardPage)?j:"info"},a.wingCardCount=5,e=function(){var b,c,d,e,f;if(a.queryResult)return d=a.card,f=a.queryResult.beforeAndAfter(d,7),c=f[0],b=f[1],e=[],c.length&&e.push({"class":"prev-0",card:_.last(c)}),e.push({"class":"current",card:d}),b.length&&e.push({"class":"next-0",card:_.first(b)}),a.cardAndNeighbours=e,c.splice(c.length,0,d),b.splice(0,0,d),a.cardsBefore=c,a.cardsAfter=b},a.$watch("selectedCard",g=function(b){return a.card=b,null==b?a.cardsBefore=a.cardsAfter=[]:(e(),"cost-to-break"!==a.cardUI.page||a.isCostToBreakEnabled(b)?void 0:a.cardUI.page="info")}),a.$watch("queryResult",e),a.isShortCard=function(a){return a.quantity<3&&"Identity"!==a.type},a.isCostToBreakEnabled=b.isCardApplicable,a.isCostToBreakVisible=function(b){return a.isCostToBreakEnabled(b)&&"cost-to-break"===a.cardUI.page},a.$watch("cardUI.page",f=function(b){return"cost-to-break"!==b||null==a.card||a.isCostToBreakEnabled(a.card)?h():a.cardUI.page="info"}),a.toggleFavourite=c.toggleCardFavourite,a.isFavourite=c.isCardFavourite,h=_.debounce(i=function(){var b,c;return c=a.card,b=a.cardUI.page,a.$apply(function(){return d.updateUrl(a.filter,c,c&&b)})},500)}]).directive("cardView",function(){return{templateUrl:"/views/directives/nr-card-view.html",restrict:"E",controller:"CardViewCtrl",link:function(){}}})}.call(this),function(){angular.module("onoSendai").controller("CostToBreakCtrl",["$scope","$attrs","costToBreakCalculator",function(a,b,c){var d,e,f,g,h,i;return h=null,g=function(){var b,c,d,e,f,g;return b=a.costToBreakInfo,d=null!=(f=null!=(g=a.opponentFilter)?g.trim().toLowerCase():void 0)?f:"",e=a.iceAdjust,null!=b?(a.opponents=_.filter(b.opponents,function(b){var c;return(_.str.include(_.stripDiacritics(b.card.title.toLowerCase()),d)||_.str.include(b.card.faction.toLowerCase(),d))&&(null==a.maxIceStrength||(null!=(c=b.card.originalstrength)?c:b.card.strength)<=a.maxIceStrength)}),c=_.filter(_.map(a.opponents,function(a){return a.interaction.creditsSpent}),function(a){return null!=a}),a.averageCredits=_.average(c),a.medianCredits=_.median(c),a.brokenCount=_.filter(a.opponents,function(a){return a.interaction.broken}).length,a.unbrokenCount=a.opponents.length-a.brokenCount):void 0},i=function(){return a.costToBreakInfo=c.calculate(a.card,a.iceAdjust,{breakerStrength:a.breakerStrength})},e=function(a,b){return a!==b?g():void 0},a.$watch("opponentFilter",e),a.$watch("maxIceStrength",e),f=function(a,b){return a!==b?(i(),g()):void 0},a.$watch("iceAdjust",f),a.$watch("breakerStrength",f),a.$watch("card",d=function(b){return null!=b?((null!=h?h.side:void 0)!==b.side&&(a.opponentFilter=null,a.iceAdjust=null,a.maxIceStrength=null),a.breakerStrength=null,c.isCardApplicable(b)&&(i(),g()),h=b):void 0})}]).directive("costToBreakCalculator",["$timeout","costToBreakCalculator",function(a){return{templateUrl:"/views/directives/nr-cost-to-break-calculator.html",restrict:"E",scope:{card:"="},controller:"CostToBreakCtrl",link:function(b,c){var d;return d=c.find(".opponents"),b.$watch("card",function(){return a(function(){return d[0].scrollTop=0})})}}}])}.call(this),function(){angular.module("onoSendai").directive("filterInput",["$window","$log","$parse",function(a){var b,c,d;return b=!(-1===(null!=(d=a.navigator)?d.userAgent.toLowerCase().indexOf("mac"):void 0)),c=".select2-focusser",{restrict:"A",link:function(a,d){var e,f,g;return g=b?["ctrl+left/ctrl+right/ctrl+esc","alt+left/alt+right/alt+esc"]:["alt+left/alt+right/alt+esc","ctrl+left/ctrl+right/ctrl+esc"],e=g[0],f=g[1],d.keydown(jwerty.event(e,function(a){return a.preventDefault()})),d.keydown(jwerty.event("esc/left/right/up/down/page-up/page-down/"+f,function(a){return a.stopPropagation()})),d.add(c).keydown(jwerty.event("enter",function(){return $(":focus").blur()}))}}}])}.call(this),function(){angular.module("onoSendai").directive("insetFilter",["$parse",function(a){return{template:'<div class="input"></div>',restrict:"E",require:"ngModel",link:function(b,c,d,e){var f,g,h,i,j,k;return i=c.find(".input"),i.attr("id",d.id),h=function(a){return i.select2({placeholder:d.placeholder,data:a,openOnEnter:!1})},f=null!=(k=a(d.insetFilterSource)(b))?k:[],h(f),b.$watch(d.insetFilterSource,g=function(a,b){return a!==b?h(a).select2("val",e.$modelValue).val(e.$modelValue).change():void 0}),e.$render=function(){return i.select2("val",e.$modelValue)},i.on("change",j=function(){return b.$$phase||b.$root.$$phase?void 0:b.$apply(function(){return e.$setViewValue(i.val())})}),c.keydown(jwerty.event("esc",function(){return i.select2("val","").change()}))}}}])}.call(this),function(){angular.module("onoSendai").directive("nrNav",["$document","cardService","$timeout","$sce",function(a,b,c,d){var e;return e=10,{templateUrl:"/views/directives/nr-nav.html",replace:!1,restrict:"E",controller:["$scope",function(a){var f;return a.previousResult=function(){var b;return(null!=(b=a.cardSearchResults)?b.selectedIndex:void 0)-1>=0?a.cardSearchResults.selectedIndex--:void 0},a.nextResult=function(){var b;return(null!=(b=a.cardSearchResults)?b.selectedIndex:void 0)+1<a.cardSearchResults.length?a.cardSearchResults.selectedIndex++:void 0},a.clearSearch=function(){var b;return b=a.cardSearchResults[a.cardSearchResults.selectedIndex],null!=b?c(function(){return a.cardSearch=""}):void 0},a.resultTitle=function(a,b){var c;return c=a.title.replace(RegExp(""+b,"i"),function(a){return"<span class='underlined'>"+a+"</span>"}),d.trustAsHtml(c)},a.$watch("cardSearch",f=function(c){return _.isEmpty(c)?(a.cardSearchResults=[],a.cardSearchResults.selectedIndex=0):b.query({search:c,byTitle:!0}).then(function(b){return a.cardSearchResults=b.orderedCards.slice(0,e),a.cardSearchResults.selectedIndex=0})})}],link:function(b,c){var d,e,f,g;return d=c.find(".card-search .dropdown-parent"),g=d.find(".dropdown-menu"),f=c.find(".card-search input"),f.keydown(jwerty.event("enter",function(a){return d.find(".dropdown-menu li.active a").click(),a.preventDefault()})),f.focus(function(){return e(b.cardSearchResults)}),f.click(function(a){return a.stopPropagation()}),g.click(function(){return b.clearSearch()}),a.click(function(){return d.removeClass("open")}),b.$watch("cardSearchResults",e=function(a){var b;return b=!!a.length,d.toggleClass("open",b)})}}}])}.call(this),function(){var a;a=function(a){switch(a){case"<":return"shift+,";case">":return"shift+.";case"!":return"shift+1";default:return a}},angular.module("onoSendai").directive("numericFilter",["$timeout","cardService",function(b,c){return{templateUrl:"/views/directives/nr-numeric-filter.html",scope:{filter:"=filterAttr",placeholder:"@",id:"@",max:"@",outerDisabled:"@uiDisabled"},restrict:"E",link:function(d,e){var f,g,h;return d.comparisonOperators=_.pluck(c.comparisonOperators,"display"),g=e.find("input"),h=d.filter.value,g.keydown(function(a){return jwerty.is("esc",a)?d.$apply(function(){return d.filter.value=void 0}):void 0}),_.each(c.comparisonOperators,function(c){var e;return e=c.typed.split("").map(a).join(","),g.keydown(jwerty.event(e,function(){return d.$apply(function(){return d.filter.operator=c.display}),b(function(){return g.val(h),g.trigger("input"),g.trigger("change")})}))}),f=!0,d.$watch("filter.operator",function(){return f?f=!1:g.focus()}),d.$watch("filter.value",function(a){return g[0].validity.valid?h=a:void 0}),d.$watch("outerDisabled",function(a){return d.uiDisabled="true"===a?!0:!1})}}}])}.call(this),function(){angular.module("onoSendai").directive("nrSubnav",["groupingUI",function(a){return{templateUrl:"/views/directives/nr-subnav.html",replace:!1,restrict:"E",controller:["$scope",function(b){return b.groupingUI=a}]}}])}.call(this),function(){angular.module("onoSendai").directive("subtypeFilter",function(){return{template:"<div></div>",restrict:"E",link:function(){}}})}.call(this),function(){angular.module("onoSendai").directive("uiAllOrOneBox",["$parse",function(a){return{restrict:"A",require:"ngModel",link:function(b,c,d,e){var f,g,h;return g=a(d.uiAllOrOneBox),f=d.uiAllOrOneBoxField,b.$watch(d.uiAllOrOneBox,h=function(a){var b;return b=_.all(a,function(a){return a})?!1:e.$modelValue,c.toggleClass("active",b)},!0),c.on("click",function(){var a,d,h;if(d=g(b),c.hasClass("active"))for(a in d)h=d[a],d[a]=!0;else{for(a in d)h=d[a],d[a]=!1;d[f]=!0}return b.$apply(function(){return e.$render()})})}}}])}.call(this),function(){angular.module("onoSendai").directive("dropdownToggle",["$document","$location",function(a){var b,c;return c=null,b=function(){},{restrict:"A",link:function(d,e){return d.$watch("$location.path",function(){return b()}),e.parent().bind("click",function(){return b()}),e.bind("click",function(d){var f,g,h,i,j,k,l,m;if(g=e===c,d.preventDefault(),d.stopPropagation(),c&&b(),!g){for(f=e.parent(),f.addClass("open"),j=e.text().trim(),h=null,m=f.find(".dropdown-menu a"),k=0,l=m.length;l>k;k++)if(i=m[k],$(i).text().trim()===j){h=$(i);break}return null==h&&(h=f.find(".dropdown-menu a:first")),h.focus(),c=e,b=function(d){return d&&(d.preventDefault(),d.stopPropagation()),a.unbind("click",b),e.parent().removeClass("open"),b=_.noop,c=null},a.bind("click",b)}})}}}]).directive("dropdownMenu",["$document",function(a){return{restrict:"A",link:function(b,c){var d,e;return d=c.parent(),e=d.find(".dropdown-toggle"),c.keydown(function(b){var f,g,h;if(jwerty.is("esc/up/down/enter/space",b)&&(b.preventDefault(),b.stopPropagation(),!c.is(".disabled, :disabled"))){if(g=d.hasClass("open"),jwerty.is("esc",b))return e.click(),e.focus(),void 0;if(jwerty.is("enter/space",b))return $(b.target).click(),void 0;if(h=c.find("a"),!_.isEmpty(h))return f=h.index(a.attr("activeElement")),jwerty.is("up",b)&&f>0?f--:jwerty.is("down",b)&&f<h.length-1&&f++,h.eq(f).focus()}})}}}])}.call(this),function(){angular.module("onoSendai").directive("uiHotkey",["$log",function(a){return jwerty.key("tab",function(){}),{restrict:"A",link:function(b,c,d){var e;return a.debug("Binding element to %s %o",d.uiHotkey,c.get(0)),e=function(a){return a.preventDefault(),c.is("button, .btn")?a.click():c.focus().select()},d.uiHotkey?jwerty.key(d.uiHotkey,e):void 0}}}])}.call(this),function(){var a,b;b=function(a,b,c,d,e){var f;return f=b.$eval(d["ui"+_.capitalize(a)]),_.each(f,function(d,f){var g,h,i,j,k;return k=_.isObject(d)?[d.action,d.preventDefault,d.stopPropagation]:[d,!1,!1],g=k[0],i=k[1],j=k[2],h=e(g),c.on(a,jwerty.event(f,function(a){return i&&a.preventDefault(),j&&a.stopPropagation(),b.$apply(function(){return h(b,{$event:a})})}))})},a=function(a){return function(c){return{restrict:"A",link:function(d,e,f){return b(a,d,e,f,c)}}}},angular.module("onoSendai").directive("uiKeydown",["$parse",a("keydown")]).directive("uiKeyup",["$parse",a("keyup")]).directive("uiKeypress",["$parse",a("keypress")])}.call(this),function(){angular.module("onoSendai").directive("main",function(){var a;return a=40,{restrict:"E",link:function(b,c){var d;return d=function(a){return function(){var b;if("hidden"!==c.css("overflow"))return b=_.isFunction(a)?a():a,c.scrollTop(c.scrollTop()+b)}},jwerty.key("up",d(-a)),jwerty.key("down",d(a)),jwerty.key("page-up",d(function(){return-c.height()})),jwerty.key("page-down",d(function(){return c.height()}))}}})}.call(this),function(){angular.module("onoSendai").directive("matrix",["$window","$q","$log","$animate","$timeout","cssUtils",function(a,b,c,d,e,f){return{restrict:"E",transclude:!0,template:'<div class="content-container" ng-transclude></div>',scope:{queryResult:"=",zoom:"=",selection:"="},link:function(d,g){var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,ab,bb;return i=g.find(".content-container"),j=null,x=!1,H=!1,G=20,Z=10,u=6,t=null,r=$([]),q=$([]),s=null,m=null,n=null,L=[],D=[],w=[],V={},J=null,W=f.getVendorPropertyName("transform"),z=1,O=g.parents(".scrollable").first(),Q=O.css("overflow"),P=O.height(),T=O.scrollTop(),v=function(){var a;return j!==(a=i.width())?(j=a,P=O.height(),!0):!1},o=function(a){return a.attributes["grid-id"].value},y=function(a){return r=i.find(".grid-item"),q=i.find(".grid-header"),null==t&&(t=_.object(_.map(r,function(a){return[o(a),a]}))),s=$(a.applyOrdering(r.add(q),o)),r=$(a.applyOrdering(r,o)),q=$(a.applyOrdering(q,o))},p=function(a,b,c){var e,f,g;return null==c&&(c=!1),g=c?1:d.zoom*z,f=""+a+":"+z,null==V[f]&&(V[f]={width:parseFloat(b.css("width")),height:parseFloat(b.css("height"))}),e=V[f],{width:e.width*g,height:e.height*g}},B=function(a){return a.classList.contains("grid-item")},A=function(a){return a.classList.contains("grid-header")},I=function(){var a,b,c,d,e,f,g,k,l,m,n,q,r,t,v,x,y,z,A,C,E,F,H,I;if(q=s,null!=q&&q.length){for(U(""),e=$(_.find(q,function(a){return a.classList.contains("grid-header")})),x=!0,F=$(_.find(q,function(a){return a.classList.contains("grid-item")&&(x=!x)})),n=p("item",F),k=p("header",e,!0),a=j-2*u,y=Math.floor((a+G)/(n.width+G)),z=y-1||1,A=Math.ceil(q.length/y),g=(a-y*n.width)/z,d=function(){var a,b;for(b=[],l=a=0;y>=0?y>a:a>y;l=y>=0?++a:--a)b.push(l*(n.width+g)+u);return b}(),L=[],D=[],w=[],f=0,b=0,c=function(a,b){var c,d,e,f;
return null==b&&(b=!1),c=_.last(L),d=b?k.height:n.height,d+=2*Z,f=c?c.position+c.height:0,e={firstElement:a,height:d,position:f},L.push(e),e},t=0,l=H=0,I=q.length;I>H;l=++H)m=q[l],B(m)?(C=Math.floor(f/y)+b,C===L.length&&(J.isShown(o(m))&&(t=C),c(m)),D.push({x:d[f%y],y:L[C].position+Z})-1,m.row=C,f++):(E=c(m,!0),w.push({x:0,y:E.position+Z}),m.row=L.length-1,b=L.length,f=0);return h(),r=L[t],v=r.position+r.height,i.height(v),R()}},h=function(){var a,b,c,e,f,g,h,i,j,k,l,m,n,p;if(!_.isEmpty(D))for(e=r,g=e.length,a=Number(d.zoom),b=j=0,l=D.length;l>j&&(f=D[b],b!==r.length);b=++j)c=r[b],J.isShown(o(c))?($(c).removeClass("hidden"),h="translate3d("+f.x+"px, "+f.y+"px, 0)                          scale("+(null!=(n=f.zoom)?n:a)*z+")",i=null!=(p=f.zIndex)?p:g-1,c.style[W]!==h&&(c.style[W]=h)):c.classList.add("hidden");if(!_.isEmpty(w))for(e=q,g=e.length,b=k=0,m=w.length;m>k&&(f=w[b],b!==q.length);b=++k)c=q[b],c.classList.remove("invisible"),c.style[W]="translate3d("+f.x+"px, "+f.y+"px, 0)"},F=function(a){return null==a&&(a=!1),g.is(":hidden")?(H=!0,void 0):(a?k().then(I).then(X):I(),H=!1)},E=_.debounce(F,300),d.$on("layout",function(a,b){return"grid"===b?e(function(){return(v()||H)&&F(!1),R()}):void 0}),U=function(a){return Q!==a?(O.css("overflow",a),Q=a,v()):void 0},R=function(){var a;return null==m||L.length<=m.row?O.scrollTop(0):(a=L[m.row],T=a.position+a.height*n,O.scrollTop(T))},S=function(){return O.scrollTop(0)},N=function(){var a,b;if(!x&&i.is(":visible"))return T=O.scrollTop(),a=_.sortedIndex(L,{position:T},function(a){return a.position})-1,0>a&&(a=0),b=L[a],m!==b.firstElement&&c.debug('New focus element determined "%s"',$(b.firstElement).attr("title")),m=b.firstElement,n=(T-b.position)/b.height},O.scroll(_.debounce(N,100)),C=function(){return d.zoom>.35},Y=function(){return d.zoom>.6?1:d.zoom>.35?2:void 0},k=function(){var a;return a=3,c.debug("Downscaling grid items to 1/"+a),M(a)},X=function(){var a;return C()?(a=Y(),c.debug("Upscaling grid items to 1/"+a),M(a)):(c.debug("Upscaling not performed (zoom level too low)"),b.when())},M=function(a){var c;return z===a?b.when():(c=g.hasClass("transitioned"),g.removeClass("transitioned"),g.removeClass("downscaled-1-"+z),z=a,g.toggleClass("downscaled-1-"+a,1!==a),h(),c?e(function(){return g.toggleClass("transitioned",c)}):b.when())},d.$watch("selection",function(a){var b;if(null!=a)return b=function(){var b;return b=g.find("[grid-id='"+a.id+"']"),b.length?(c.debug('New focus element determined "%s"',b.attr("title")),m=b.get(0),n=-.02):(console.warn("No element found with grid-id "+a.id),void 0)},l?e(b):b()}),d.$watch("layoutMode",function(a){return"grid"===a?R():void 0}),l=!0,d.$watch("queryResult",K=function(a){c.debug("Laying out (query)"),J=a,e(function(){var a;if(null!=J)return y(J),a=F(l),S(),l=!1})}),d.$on("zoomStart",function(){return"function"==typeof console.groupCollapsed&&console.groupCollapsed("Zoom"),e(function(){return k()}),x=!0}),d.$on("zoomEnd",function(){return c.debug("New zoom level: "+d.zoom),X(),x=!1,"function"==typeof console.groupEnd?console.groupEnd("Zoom"):void 0}),d.$watch("zoom",bb=function(){return F()}),$(a).resize(ab=function(){return v()?(c.debug("Laying out grid (grid width change)"),F(!1)):void 0})}}}])}.call(this),function(){var a;a=function(a){switch(a){case"identity":return"identities";case"ice":case"hardware":return a;default:return""+a+"s"}},angular.module("onoSendai").filter("cardUrl",["$log","$location",function(b,c){var d,e;return d=null!=c.host().match(/localhost/),e=c.$$html5?"":"#!",function(c,d,f){var g;if(null==c)return"";switch(g=c.side.toLowerCase(),d){case"card":return""+e+"/cards/"+g+"/card/"+c.id;case"type":return""+e+"/cards/"+g+"/"+a(c.type.toLowerCase());case"set":return""+e+"/cards/"+g+"?setname="+_.idify(c.setname)+"&group=setname";case"subtype":return""+e+"/cards/"+g+"?subtype="+_.idify(f);case"image":return c.imagesrc;default:return b.warn("cardUrl: Unknown urlType "+d),""}}}])}.call(this),function(){var a;a=function(a,b){var c;switch(b){case"type":switch(a){case"Agenda":case"Asset":case"Operation":case"Upgrade":case"Event":case"Program":case"Resource":return""+a+"s";case"Identity":return"Identities";default:return a}break;case"cost":return a=parseInt(a),_.isNaN(a)?"Cost N/A":(c=""+a+" Credit",(0===a||a>1)&&(c+="s"),c);case"factioncost":return""!==a?""+a+" Influence":"Influence N/A";default:return a}},angular.module("onoSendai").filter("primaryGroupTitle",function(){return function(b,c){return c.length>1?a(b[1],c[1]):a(b[0],c[0])}}).filter("secondaryGroupTitle",["cardService","dateFilter",function(b,c){return function(d,e){var f,g;return e.length>1?a(d[0],e[0]):"setname"===e[0]?(f=null!=(g=b.getSetByTitle(d[0]))?g.released:void 0,null!=f?c(f,"MMM. y"):""):""}}])}.call(this),function(){angular.module("onoSendai").run(["$rootScope",function(a){return a.$safeApply=function(a){return this.$$phase?a():this.$apply(a)}}])}.call(this);